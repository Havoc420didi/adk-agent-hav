# å®‰å…¨é€€å‡ºæŒ‡å—

## é—®é¢˜èƒŒæ™¯

åœ¨ä½¿ç”¨ `Ctrl+C` åœæ­¢ Web æœåŠ¡æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

```
asyncio.exceptions.CancelledError
KeyboardInterrupt
```

è¿™äº›é”™è¯¯æ˜¯ç”±äºåœ¨æ¸…ç†èµ„æºè¿‡ç¨‹ä¸­ï¼Œ`asyncio.sleep()` å‡½æ•°è¢«é”®ç›˜ä¸­æ–­ä¿¡å·å–æ¶ˆå¯¼è‡´çš„ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿¡å·å¤„ç†æœºåˆ¶

å®ç°äº† `GracefulKiller` ç±»æ¥ä¼˜é›…åœ°å¤„ç†é€€å‡ºä¿¡å·ï¼š

```python
class GracefulKiller:
    """ä¼˜é›…é€€å‡ºå¤„ç†å™¨"""
    def __init__(self):
        self.kill_now = False
        signal.signal(signal.SIGINT, self._exit_gracefully)
        signal.signal(signal.SIGTERM, self._exit_gracefully)

    def _exit_gracefully(self, signum, frame):
        print(f"\nğŸ›‘ æ¥æ”¶åˆ°é€€å‡ºä¿¡å· ({signum})ï¼Œæ­£åœ¨å®‰å…¨é€€å‡º...")
        self.kill_now = True
```

### 2. å®‰å…¨çš„å¼‚æ­¥ç­‰å¾…

å¼•å…¥äº† `safe_sleep()` æ–¹æ³•æ¥æ›¿ä»£ `asyncio.sleep()`ï¼š

```python
@staticmethod
async def safe_sleep(duration: float, step: float = 0.01):
    """å®‰å…¨çš„å¼‚æ­¥ç­‰å¾…ï¼Œä¸ä¼šè¢«å–æ¶ˆä¸­æ–­"""
    try:
        elapsed = 0.0
        while elapsed < duration:
            try:
                sleep_time = min(step, duration - elapsed)
                await asyncio.sleep(sleep_time)
                elapsed += sleep_time
            except asyncio.CancelledError:
                # è¢«å–æ¶ˆæ—¶ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›
                break
    except Exception:
        # å¿½ç•¥æ‰€æœ‰å…¶ä»–å¼‚å¸¸
        pass
```

### 3. åˆ†å±‚æ¸…ç†æœºåˆ¶

å®ç°äº†ä¸‰å±‚æ¸…ç†æœºåˆ¶ï¼š

#### ç¬¬ä¸€å±‚ï¼šå®‰å…¨æ¸…ç†
- `safe_comprehensive_cleanup()` - æ­£å¸¸æƒ…å†µä¸‹çš„å…¨é¢æ¸…ç†
- ä½¿ç”¨ `safe_sleep()` é¿å…è¢«ä¸­æ–­
- æœ‰è¶…æ—¶ä¿æŠ¤æœºåˆ¶

#### ç¬¬äºŒå±‚ï¼šå¸¦è¶…æ—¶çš„æ¸…ç†
- åœ¨ `safe_cleanup()` å‡½æ•°ä¸­ä½¿ç”¨ `asyncio.wait_for()` è®¾ç½®è¶…æ—¶
- è¶…æ—¶åè‡ªåŠ¨é™çº§åˆ°ç´§æ€¥æ¸…ç†

#### ç¬¬ä¸‰å±‚ï¼šç´§æ€¥æ¸…ç†
- `emergency_cleanup()` - æœ€å°åŒ–å¼‚æ­¥æ“ä½œçš„æ¸…ç†
- ä¸»è¦æ‰§è¡ŒåŒæ­¥æ“ä½œå¦‚åƒåœ¾å›æ”¶
- ç¡®ä¿ç¨‹åºèƒ½æ­£å¸¸é€€å‡º

### 4. ä¸»ç¨‹åºæ”¹è¿›

- ä½¿ç”¨ä»»åŠ¡ç›‘æ§æœºåˆ¶ï¼Œå®šæœŸæ£€æŸ¥é€€å‡ºä¿¡å·
- å–æ¶ˆé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡è€Œä¸æ˜¯å¼ºåˆ¶ç»ˆæ­¢
- åˆ†ç¦»æ¸…ç†é€»è¾‘åˆ°ç‹¬ç«‹å‡½æ•° `safe_cleanup()`

## ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨åº”ç”¨

```bash
# Web æ¨¡å¼
python main.py --mode web

# æ§åˆ¶å°æ¨¡å¼
python main.py --mode console
```

### å®‰å…¨é€€å‡º

1. **æ¨èæ–¹å¼**: æŒ‰ `Ctrl+C` ä¸€æ¬¡ï¼Œç­‰å¾…ç¨‹åºå®Œæˆæ¸…ç†
2. **ç´§æ€¥é€€å‡º**: å¦‚æœæ¸…ç†è¿‡ç¨‹å¡ä½ï¼Œå¯ä»¥å†æ¬¡æŒ‰ `Ctrl+C` å¼ºåˆ¶é€€å‡º

### æµ‹è¯•å®‰å…¨é€€å‡ºæœºåˆ¶

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
python test_safe_exit.py

# é€‰æ‹©æµ‹è¯•æ¨¡å¼
# 1. æµ‹è¯•å®‰å…¨æ¸…ç†åŠŸèƒ½
# 2. æµ‹è¯•ä¸­æ–­å¤„ç†
```

## æ”¹è¿›æ•ˆæœ

### ä¹‹å‰çš„é—®é¢˜

```
^CINFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
ğŸ§¹ æ­£åœ¨æ¸…ç†èµ„æº...
Traceback (most recent call last):
  ...
  File "/path/to/cleanup_helper.py", line 110, in cleanup_litellm_resources
    await asyncio.sleep(0.1)
asyncio.exceptions.CancelledError
```

### æ”¹è¿›åçš„æ•ˆæœ

```
^C
ğŸ›‘ æ¥æ”¶åˆ°é€€å‡ºä¿¡å· (2)ï¼Œæ­£åœ¨å®‰å…¨é€€å‡º...

ğŸ›‘ æ­£åœ¨åœæ­¢ Web æœåŠ¡...
ğŸ§¹ å¼€å§‹æ¸…ç†èµ„æº...
âœ… æ¥å£èµ„æºæ¸…ç†å®Œæˆ
âœ… å…¨é¢èµ„æºæ¸…ç†å®Œæˆ
ğŸ§¹ èµ„æºæ¸…ç†å®Œæˆ
ğŸ‘‹ åº”ç”¨å·²å®‰å…¨é€€å‡º
```

## é…ç½®é€‰é¡¹

å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è°ƒæ•´æ¸…ç†è¡Œä¸ºï¼š

```bash
# è®¾ç½®æ¥å£æ¸…ç†è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
export INTERFACE_CLEANUP_TIMEOUT=5

# è®¾ç½®å…¨é¢æ¸…ç†è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
export COMPREHENSIVE_CLEANUP_TIMEOUT=10

# ç¦ç”¨ aiohttp ä¼ è¾“ï¼ˆé¿å…è­¦å‘Šï¼‰
export DISABLE_AIOHTTP_TRANSPORT=True
```

## æ•…éšœæ’é™¤

### å¦‚æœæ¸…ç†è¿‡ç¨‹ä»ç„¶å¡ä½

1. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è¿›ç¨‹å ç”¨ç›¸åŒç«¯å£
2. ç¡®ä¿æ²¡æœ‰æœªå…³é—­çš„æ–‡ä»¶å¥æŸ„
3. æŸ¥çœ‹æ˜¯å¦æœ‰æ­»é”çš„å¼‚æ­¥ä»»åŠ¡

### å¦‚æœå‡ºç°èµ„æºæ³„æ¼è­¦å‘Š

1. ç¡®ä¿æ‰€æœ‰å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨éƒ½æ­£ç¡®å…³é—­
2. æ£€æŸ¥æ˜¯å¦æœ‰æœª await çš„åç¨‹
3. è€ƒè™‘å¢åŠ æ¸…ç†è¶…æ—¶æ—¶é—´

## æœ€ä½³å®è·µ

1. **æ€»æ˜¯ä½¿ç”¨ Ctrl+C ä¸€æ¬¡**: ç»™ç¨‹åºæ—¶é—´æ‰§è¡Œæ¸…ç†
2. **é¿å…å¼ºåˆ¶ç»ˆæ­¢**: é™¤éç»å¯¹å¿…è¦ï¼Œå¦åˆ™ä¸è¦ä½¿ç”¨ `kill -9`
3. **ç›‘æ§æ¸…ç†æ—¶é—´**: å¦‚æœæ¸…ç†æ—¶é—´è¿‡é•¿ï¼Œè€ƒè™‘ä¼˜åŒ–èµ„æºç®¡ç†
4. **æµ‹è¯•é€€å‡ºæœºåˆ¶**: å®šæœŸè¿è¡Œæµ‹è¯•è„šæœ¬ç¡®ä¿é€€å‡ºæœºåˆ¶æ­£å¸¸å·¥ä½œ

## æŠ€æœ¯ç»†èŠ‚

### ä¿¡å·å¤„ç†

- `SIGINT` (Ctrl+C): ç”¨æˆ·ä¸­æ–­ä¿¡å·
- `SIGTERM`: ç»ˆæ­¢ä¿¡å·ï¼ˆç³»ç»Ÿå…³é—­æ—¶ï¼‰
- ä¸¤ä¸ªä¿¡å·éƒ½ä¼šè§¦å‘ä¼˜é›…é€€å‡ºæµç¨‹

### å¼‚æ­¥ä»»åŠ¡ç®¡ç†

- ä½¿ç”¨ `asyncio.create_task()` åˆ›å»ºå¯å–æ¶ˆçš„ä»»åŠ¡
- ç›‘æ§ä»»åŠ¡çŠ¶æ€ï¼ŒåŠæ—¶å–æ¶ˆé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
- é¿å…é˜»å¡æ€§æ“ä½œå½±å“é€€å‡ºæµç¨‹

### èµ„æºæ¸…ç†é¡ºåº

1. åœæ­¢æ¥å—æ–°è¯·æ±‚
2. å®Œæˆæ­£åœ¨å¤„ç†çš„è¯·æ±‚
3. å…³é—­ç½‘ç»œè¿æ¥
4. æ¸…ç†å†…å­˜èµ„æº
5. æ‰§è¡Œåƒåœ¾å›æ”¶ 